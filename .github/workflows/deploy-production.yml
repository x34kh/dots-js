name: Deploy Production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]

env:
  REGISTRY: ${{ secrets.REGISTRY_URL }}

jobs:
  deploy:
    runs-on: linux-training
    # Only deploy if CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: production
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Get image tag from CI run
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
          # Verify kubectl can connect
          kubectl cluster-info || { echo "Failed to connect to cluster"; cat ~/.kube/config; exit 1; }
          kubectl get nodes || { echo "Cannot access cluster nodes"; exit 1; }

      - name: Deploy to Kubernetes
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}
          REGISTRY: ${{ secrets.REGISTRY_URL }}
        run: |
          echo "=== Deploy Information ==="
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          echo "Workflow run SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Image tag: $IMAGE_TAG"
          echo "Frontend image: $REGISTRY/frontend:$IMAGE_TAG"
          echo "Backend image: $REGISTRY/backend:$IMAGE_TAG"
          echo "=========================="
          
          # Verify images exist in registry
          echo "Verifying frontend image exists..."
          curl -f http://$REGISTRY/v2/frontend/manifests/$IMAGE_TAG || { echo "Frontend image not found"; exit 1; }
          echo "Verifying backend image exists..."
          curl -f http://$REGISTRY/v2/backend/manifests/$IMAGE_TAG || { echo "Backend image not found"; exit 1; }
          echo "Images verified successfully"
          
          # Create namespace if it doesn't exist
          kubectl create namespace dots-production --dry-run=client -o yaml | kubectl apply -f -
          
          # Apply secrets from GitHub secrets
          kubectl create secret generic dots-secrets \
            --namespace dots-production \
            --from-literal=GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
            --from-literal=ANONYMOUS_SECRET="${{ secrets.ANONYMOUS_SECRET }}" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # Update image tags in deployment files and apply
          cd k8s/production
          sed "s|image: .*frontend.*|image: $REGISTRY/frontend:$IMAGE_TAG|g" frontend.yaml | kubectl apply -f -
          sed "s|image: .*backend.*|image: $REGISTRY/backend:$IMAGE_TAG|g" backend.yaml | kubectl apply -f -
          
          # Apply other manifests
          kubectl apply -f namespace.yaml
          kubectl apply -f redis.yaml
          kubectl apply -f cloudflared.yaml
          kubectl apply -f ingress.yaml
          
          # Wait for rollout
          kubectl rollout status deployment/dots-frontend -n dots-production --timeout=300s
          kubectl rollout status deployment/dots-backend -n dots-production --timeout=300s
